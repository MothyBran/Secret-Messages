<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SECURE MESSAGES | Security Hub</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link href="/assets/fonts/fonts.css" rel="stylesheet">
    <link href="/assets/css/ui.css" rel="stylesheet">
    <script src="/assets/js/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0f1215;
            --accent-blue: #00BFFF;
            --accent-glow: rgba(0, 191, 255, 0.3);
            --text-main: #e0e0e0;
            --text-muted: #8899a6;
            --border-color: #333;
            --success-green: #00ff88;
            --error-red: #ff3333;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            margin: 0;
        }

        .bg-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                linear-gradient(rgba(0, 191, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 191, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            z-index: -1; pointer-events: none;
        }

        /* HEADER */
        header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 20px; background: rgba(15, 18, 21, 0.9);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100;
        }
        .app-logo { font-weight: 700; font-size: 1.2rem; letter-spacing: 2px; display: flex; align-items: center; gap: 10px; color: #fff; text-decoration: none; }
        .shield-icon { width: 24px; height: 24px; fill: var(--accent-blue); }
        .btn-back { border: 1px solid var(--accent-blue); color: var(--accent-blue); background: rgba(0, 191, 255, 0.1); padding: 8px 16px; text-decoration: none; font-size: 0.9rem; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        .btn-back:hover { background: rgba(0, 191, 255, 0.2); box-shadow: 0 0 10px var(--accent-glow); }

        /* MAIN CONTAINER */
        .hub-container {
            width: 100%; max-width: 800px; margin: 0 auto; padding: 20px; flex: 1;
        }

        /* SEARCH BAR */
        .search-wrapper {
            position: relative; margin-bottom: 30px;
        }
        .search-input {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border-color); color: #fff;
            padding: 15px; padding-left: 45px; font-size: 1.1rem; border-radius: 8px; font-family: 'Roboto Mono';
            transition: 0.3s;
        }
        .search-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(0, 191, 255, 0.1); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #666; font-size: 1.2rem; }

        /* FEATURED POST */
        .featured-card {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; margin-bottom: 40px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        .featured-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-color: var(--accent-blue); }
        .featured-image {
            width: 100%; height: 300px; object-fit: cover; border-bottom: 1px solid var(--border-color);
        }
        .featured-content { padding: 25px; }
        .post-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .tag-info { background: rgba(0, 191, 255, 0.1); color: var(--accent-blue); border: 1px solid var(--accent-blue); }
        .tag-wichtig { background: rgba(255, 165, 0, 0.1); color: orange; border: 1px solid orange; }
        .tag-kritisch { background: rgba(255, 50, 50, 0.1); color: var(--error-red); border: 1px solid var(--error-red); }

        .post-title { font-size: 2rem; margin-bottom: 10px; color: #fff; line-height: 1.2; word-wrap: break-word; overflow-wrap: break-word; }
        .post-subtitle { color: var(--text-muted); font-size: 1.1rem; margin-bottom: 15px; word-wrap: break-word; overflow-wrap: break-word; }
        .post-meta { display: flex; gap: 15px; color: #666; font-size: 0.9rem; align-items: center; flex-wrap: wrap; }

        /* TIMELINE LIST */
        .timeline-list { display: flex; flex-direction: column; gap: 15px; }
        .timeline-item {
            display: flex; gap: 15px; padding: 15px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: 0.2s; align-items: center;
            width: 100%;
        }
        .timeline-item:hover { background: rgba(255,255,255,0.05); border-color: #555; }
        .timeline-thumb { width: 80px; height: 80px; border-radius: 6px; object-fit: cover; background: #111; flex-shrink: 0; }
        .timeline-info { flex: 1; min-width: 0; /* Important for word-wrap inside flex */ }
        .timeline-title { font-size: 1.1rem; color: #fff; font-weight: bold; margin-bottom: 5px; word-wrap: break-word; overflow-wrap: break-word; }
        .timeline-date { font-size: 0.8rem; color: #666; }

        /* DETAIL VIEW WRAPPER */
        .forum-detail-container {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        /* DETAIL VIEW */
        #detailView { display: none; animation: fadeIn 0.4s ease; }
        .detail-header-img { width: 100%; height: 350px; object-fit: cover; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .detail-content { font-family: 'Roboto Mono', monospace; line-height: 1.6; color: #ccc; font-size: 1rem; margin-bottom: 40px; word-wrap: break-word; overflow-wrap: break-word; }
        .detail-content h1, .detail-content h2, .detail-content h3 { color: #fff; margin-top: 20px; margin-bottom: 10px; font-family: 'Rajdhani', sans-serif; }
        .detail-content a { color: var(--accent-blue); }
        .detail-content img { max-width: 100%; border-radius: 6px; margin: 10px 0; }
        .detail-content blockquote { border-left: 3px solid var(--accent-blue); padding-left: 15px; color: #888; margin: 15px 0; }

        /* INTERACTION BAR */
        .interaction-bar {
            display: flex; gap: 20px; padding: 20px; background: rgba(0,0,0,0.5); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 40px; justify-content: center; flex-wrap: wrap;
        }
        .vote-btn {
            background: transparent; border: 1px solid #444; color: #888; padding: 10px 20px; border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 1rem;
        }
        .vote-btn:hover { border-color: #666; color: #fff; }
        .vote-btn.active.like { border-color: var(--success-green); color: var(--success-green); background: rgba(0, 255, 136, 0.1); }
        .vote-btn.active.dislike { border-color: var(--error-red); color: var(--error-red); background: rgba(255, 50, 50, 0.1); }
        .vote-btn.active.question { border-color: orange; color: orange; background: rgba(255, 165, 0, 0.1); }

        /* COMMENTS */
        .comments-section { border-top: 1px solid var(--border-color); padding-top: 30px; }
        .comment-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #222;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
            position: relative;
        }
        /* Role based styles */
        .comment-item.role-founder { border-left: 3px solid #00ff88; box-shadow: -5px 0 10px rgba(0, 255, 136, 0.05); }
        .comment-item.role-partner { border-left: 3px solid #c0c0c0; box-shadow: -5px 0 10px rgba(192, 192, 192, 0.05); }
        .comment-item.role-pro { border-left: 3px solid #ffd700; box-shadow: -5px 0 10px rgba(255, 215, 0, 0.05); }
        .comment-item.role-vip { border-left: 3px solid #00d1ff; box-shadow: -5px 0 10px rgba(0, 209, 255, 0.05); }

        /* Pinned Style */
        .comment-item.pinned {
            border: 1px solid var(--accent-blue);
            background: rgba(0, 191, 255, 0.05);
        }
        .pinned-badge {
            position: absolute; top: 10px; right: 10px;
            font-size: 0.7rem; color: var(--accent-blue); border: 1px solid var(--accent-blue);
            padding: 2px 5px; border-radius: 4px; font-weight: bold;
        }

        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; flex-wrap: wrap; }
        .comment-user-area { display: flex; align-items: center; gap: 8px; }
        .comment-user { color: var(--accent-blue); font-weight: bold; font-size: 0.95rem; }
        .user-badge { font-size: 0.9rem; }
        .comment-date { color: #666; font-size: 0.8rem; }
        .comment-text { color: #ddd; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; margin-bottom: 10px; }

        .comment-actions { display: flex; gap: 15px; font-size: 0.8rem; color: #666; align-items: center; }
        .action-btn { background: none; border: none; color: #666; cursor: pointer; display: flex; gap: 5px; align-items: center; transition: 0.2s; }
        .action-btn:hover { color: #fff; }
        .action-btn.active { color: var(--accent-blue); }
        .mod-btn { color: var(--error-red); }

        /* Nested Comments */
        .replies-container { margin-top: 10px; border-left: 2px solid #333; padding-left: 15px; }
        /* Max indentation handled by JS or simple CSS for deep nesting if flat list rendering used,
           but here we use nested divs. Limit visual indentation on mobile. */
        @media (max-width: 600px) {
            .replies-container { padding-left: 10px; border-left: 1px solid #333; }
        }

        .comment-form { margin-top: 20px; background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .comment-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; font-family: 'Roboto Mono'; margin-bottom: 10px; resize: vertical; }
        .btn-comment { background: var(--accent-blue); color: #000; border: none; padding: 8px 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; border-radius: 4px; }
        .btn-comment:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-cancel { background: transparent; border: 1px solid #555; color: #ccc; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px; }

        .auth-overlay { text-align: center; padding: 20px; color: #888; border: 1px dashed #444; border-radius: 8px; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .auth-overlay:hover { border-color: var(--accent-blue); color: #fff; }

        /* AUTH MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 10000;
        }
        .modal-box {
            background: var(--bg-panel); border: 1px solid var(--accent-blue);
            padding: 30px; width: 90%; max-width: 400px;
            box-shadow: 0 0 50px rgba(0, 191, 255, 0.2);
            position: relative; text-align: center; border-radius: 12px;
        }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SIDEBAR */
        .forum-sidebar {
            width: 280px; background: rgba(15, 18, 21, 0.95); border-right: 1px solid var(--border-color);
            padding: 20px; display: none; flex-direction: column; gap: 30px;
            height: calc(100vh - 70px); position: sticky; top: 70px; overflow-y: auto; flex-shrink: 0;
        }
        .forum-sidebar.active { display: flex; }
        .sidebar-section h4 { color: var(--accent-blue); margin-bottom: 15px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-btn {
            background: transparent; border: 1px solid #333; color: #ccc; width: 100%; padding: 10px; text-align: left;
            margin-bottom: 10px; cursor: pointer; border-radius: 6px; transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .sidebar-btn:hover { border-color: var(--accent-blue); color: #fff; background: rgba(0, 191, 255, 0.05); }

        .activity-feed { display: flex; flex-direction: column; gap: 10px; }
        .activity-item { font-size: 0.85rem; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; border-left: 2px solid #333; }
        .activity-item.reply { border-left-color: var(--accent-blue); }
        .activity-item.like { border-left-color: var(--success-green); }
        .activity-time { font-size: 0.7rem; color: #666; display: block; margin-top: 5px; }

        /* Bookmark Icon in Card */
        .card-actions { display: flex; justify-content: flex-end; padding: 0 25px 15px; position: relative; z-index: 2; }
        .btn-bookmark { background: none; border: none; color: #666; cursor: pointer; font-size: 1.2rem; transition: 0.2s; padding: 5px; }
        .btn-bookmark:hover { color: gold; }
        .btn-bookmark.active { color: gold; }

        /* MOBILE TWEAKS */
        @media (max-width: 768px) {
            .forum-sidebar {
                position: fixed; top: 60px; left: 0; width: 100%; height: calc(100vh - 60px); z-index: 90;
            }
            .hub-container { padding: 15px; max-width: 100%; }
            .featured-image { height: 200px; }
            .post-title { font-size: 1.5rem; }

            .timeline-item { flex-direction: column; align-items: flex-start; width: 100%; }
            .timeline-thumb { width: 100%; height: 180px; margin-bottom: 10px; }

            .interaction-bar { gap: 10px; }
            .vote-btn { padding: 8px 12px; font-size: 0.9rem; flex: 1; justify-content: center; }

            .detail-header-img { height: 200px; }
        }
    </style>
</head>
<body>

    <div class="bg-grid"></div>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button id="sidebarToggle" onclick="toggleSidebar()" class="btn-icon" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">‚ò∞</button>
            <a href="/app" class="app-logo">
                <svg class="shield-icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                <span>SECURE MSG FORUM</span>
            </a>
        </div>
        <a href="/app" class="btn-back">‚Üê ZUR APP</a>
    </header>

    <div class="main-wrapper" style="display:flex; min-height: calc(100vh - 70px);">
        <!-- SIDEBAR -->
        <div id="forumSidebar" class="forum-sidebar">
            <div class="sidebar-section">
                <h4>Meine Inhalte</h4>
                <button class="sidebar-btn" onclick="showSection('bookmarks')">üîñ Gespeicherte Beitr√§ge</button>
                <button class="sidebar-btn" onclick="showSection('my-comments')">üí¨ Meine Kommentare</button>
                <button class="sidebar-btn" onclick="showSection('all')">üè† Alle Beitr√§ge</button>
            </div>
            <div class="sidebar-section">
                <h4>Aktivit√§t</h4>
                <div id="activityFeed" class="activity-feed">
                    <!-- JS fills this -->
                </div>
            </div>
        </div>

        <div class="hub-container">

        <!-- HUB VIEW -->
        <div id="hubView">
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Suche nach Security-Updates...">
            </div>

            <div id="featuredContainer">
                <!-- Featured Post injected here -->
            </div>

            <h3 style="color:var(--text-muted); margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">ARCHIV & TIMELINE</h3>
            <div id="timelineContainer" class="timeline-list">
                <!-- List injected here -->
            </div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="detailView">
            <div class="forum-detail-container">
                <button onclick="showHub()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-bottom:20px; font-size:1rem; display:flex; align-items:center; gap:5px;">
                    ‚Üê Zur√ºck zur √úbersicht
                </button>

                <div id="postDetailContent">
                    <!-- Content injected here -->
                </div>

                <div class="interaction-bar">
                    <button class="vote-btn" onclick="vote('like')">üëçüèª <span id="countLike">0</span></button>
                    <button class="vote-btn" onclick="vote('dislike')">üëéüèª <span id="countDislike">0</span></button>
                    <button class="vote-btn" onclick="vote('question')">‚ùì <span id="countQuestion">0</span></button>
                </div>

                <div class="comments-section">
                    <h3 style="color:#fff; margin-bottom:20px;">Diskussion</h3>

                    <div id="commentFormRoot">
                        <!-- Main Comment Form -->
                    </div>

                    <div id="commentsList">
                        <!-- Comments injected here -->
                    </div>
                </div>
            </div>
        </div>

        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="authModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close" onclick="closeAuthModal()">√ó</button>
            <h3 style="color:var(--accent-blue); margin-bottom:15px;">Login Erforderlich</h3>
            <p style="color:#ccc; margin-bottom:25px; line-height:1.5;">
                Um an der Diskussion teilzunehmen oder abzustimmen, loggen Sie sich bitte in der Secure App ein.
            </p>
            <a href="/landing.html" class="btn-comment" style="display:inline-block; text-decoration:none;">Zum Login</a>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>

    <script src="/assets/js/ui.js"></script>
    <script>
        // FORUM LOGIC
        const API_BASE = '/api';
        let allPosts = [];
        let currentPostId = null;
        let authToken = null;
        let currentUser = null;
        let isAdmin = false;
        let userBookmarks = new Set();
        let currentSection = 'all';

        try {
            authToken = localStorage.getItem('sm_token');
            const userStr = localStorage.getItem('sm_user');
            if(userStr) currentUser = JSON.parse(userStr);
            if(authToken) {
                try {
                    const payload = JSON.parse(atob(authToken.split('.')[1]));
                    if(payload.role === 'admin' || payload.role === 'dev') isAdmin = true;
                } catch(e) {}

                // Fallback check for UI elements if token doesn't have role yet but badge says so
                if (!isAdmin && currentUser && (currentUser.badge && (currentUser.badge.includes('Admin') || currentUser.badge.includes('Dev')))) {
                    isAdmin = true;
                }
            }
        } catch(e){}

        window.toggleSidebar = function() {
            const sb = document.getElementById('forumSidebar');
            if(sb) sb.classList.toggle('active');
        };

        window.showSection = function(section) {
            if (section !== 'all' && !authToken) return showLoginModal();

            // Close sidebar on mobile after selection
            if(window.innerWidth < 768) {
                document.getElementById('forumSidebar').classList.remove('active');
            }

            currentSection = section;
            showHub(); // Ensure we are in Hub View

            // Highlight active button
            document.querySelectorAll('.sidebar-btn').forEach(b => b.style.color = '');
            const activeBtn = document.querySelector(`button[onclick="showSection('${section}')"]`);
            if(activeBtn) activeBtn.style.color = 'var(--accent-blue)';

            if(section === 'all') {
                document.getElementById('featuredContainer').style.display = 'block';
                loadPosts('/posts');
            } else if(section === 'bookmarks') {
                document.getElementById('featuredContainer').style.display = 'none'; // No featured in bookmarks
                loadPosts('/bookmarks');
            } else if(section === 'my-comments') {
                document.getElementById('featuredContainer').style.display = 'none';
                loadPosts('/user/comments');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const postIdParam = params.get('post');

            // Default load
            loadPosts().then(() => {
                if(postIdParam) {
                    openPost(postIdParam);
                }
            });

            document.getElementById('searchInput').addEventListener('input', (e) => filterPosts(e.target.value));

            if(authToken) {
                loadActivity();
            } else {
                renderActivityPlaceholder();
            }
        });

        function renderActivityPlaceholder() {
            const container = document.getElementById('activityFeed');
            if(container) {
                container.innerHTML = `
                    <div style="padding:10px; color:#888; font-size:0.8rem; cursor:pointer; border:1px dashed #333; border-radius:6px; text-align:center;" onclick="showLoginModal()">
                        üîí Anmelden f√ºr Aktivit√§ten
                    </div>
                `;
            }
        }

        async function loadActivity() {
            const container = document.getElementById('activityFeed');
            if(!container) return;
            container.innerHTML = '<div style="color:#666; font-size:0.8rem; padding:10px;">Lade...</div>';

            try {
                const res = await fetch(`${API_BASE}/forum/activity`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if(!res.ok) throw new Error();
                const activities = await res.json();

                if(activities.length === 0) {
                    container.innerHTML = '<div style="color:#666; font-size:0.8rem; padding:10px;">Keine Aktivit√§ten.</div>';
                    return;
                }

                container.innerHTML = '';
                activities.forEach(act => {
                    const item = document.createElement('div');
                    item.className = `activity-item ${act.type}`;
                    item.onclick = () => openPost(act.post_id || act.id); // Fallback
                    item.style.cursor = 'pointer';

                    let icon = 'üí¨';
                    if(act.type === 'like') icon = '‚ù§Ô∏è';

                    item.innerHTML = `
                        <div style="font-weight:bold; color:#fff; display:flex; justify-content:space-between;">
                        <span>${icon} ${escapeHtml(act.actor || 'Jemand')}</span>
                        </div>
                        <div style="color:#bbb; margin-top:2px; line-height:1.2;">
                        ${escapeHtml(act.text)}
                        </div>
                        <span class="activity-time">${new Date(act.created_at).toLocaleDateString()}</span>
                    `;
                    container.appendChild(item);
                });

            } catch(e) {
                container.innerHTML = '<div style="color:#666; font-size:0.8rem; padding:10px;">Fehler beim Laden.</div>';
            }
        }

        async function loadPosts(endpoint = '/posts') {
            try {
                const headers = {};
                if(authToken) headers['Authorization'] = `Bearer ${authToken}`;

                // Load bookmarks first if logged in
                if(authToken && !endpoint.includes('comments')) {
                    try {
                        const bmRes = await fetch(`${API_BASE}/bookmarks`, { headers });
                        const bmData = await bmRes.json();
                        userBookmarks = new Set(bmData.map(b => b.id));
                    } catch(e) {}
                }

                const res = await fetch(`${API_BASE}${endpoint}`, { headers });
                if(!res.ok) throw new Error(`HTTP Error ${res.status}`);
                let data = await res.json();

                // If My Comments, data structure is different (comments, not posts)
                if(endpoint.includes('comments')) {
                    renderMyComments(data);
                    return;
                }

                allPosts = data;
                renderHub();
            } catch(e) {
                console.error("List Load failed", e);
                const container = document.getElementById('timelineContainer');
                if(container) container.innerHTML = '<div style="color:var(--error-red); text-align:center; padding:20px;">Fehler beim Laden der Beitr√§ge.</div>';
            }
        }

        function renderMyComments(comments) {
            const timelineContainer = document.getElementById('timelineContainer');
            const featuredContainer = document.getElementById('featuredContainer');

            // Hide featured section for this view
            if(featuredContainer) featuredContainer.innerHTML = '';

            timelineContainer.innerHTML = '';

            if(!comments || comments.length === 0) {
                timelineContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Keine Kommentare gefunden.</div>';
                return;
            }

            comments.forEach(c => {
               const item = document.createElement('div');
               item.className = 'timeline-item';
               item.style.display = 'block'; // Override flex row
               item.onclick = () => openPost(c.post_id);

               item.innerHTML = `
                    <div style="font-size:0.8rem; color:var(--accent-blue); margin-bottom:5px;">
                        In: ${escapeHtml(c.post_title || 'Unbekannter Beitrag')}
                    </div>
                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:4px; border-left:2px solid #555; font-style:italic; color:#ccc; margin-bottom:5px;">
                        "${escapeHtml(c.comment.substring(0, 100))}${c.comment.length > 100 ? '...' : ''}"
                    </div>
                    <div style="font-size:0.7rem; color:#666;">
                        ${new Date(c.created_at).toLocaleString()}
                    </div>
               `;
               timelineContainer.appendChild(item);
            });
        }

        function renderHub() {
            const featuredContainer = document.getElementById('featuredContainer');
            const timelineContainer = document.getElementById('timelineContainer');

            featuredContainer.innerHTML = '';
            timelineContainer.innerHTML = '';

            if(allPosts.length === 0) {
                timelineContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Keine Beitr√§ge vorhanden.</div>';
                return;
            }

            const renderTag = (p) => {
                let cls = 'tag-info';
                if(p === 'Wichtig') cls = 'tag-wichtig';
                if(p === 'Kritisch') cls = 'tag-kritisch';
                return `<span class="post-tag ${cls}">${p}</span>`;
            };

            // Helpers
            const renderListItem = (p) => {
                const thumb = p.image_url ? `<img src="${p.image_url}" class="timeline-thumb">` : `<div class="timeline-thumb" style="display:flex;align-items:center;justify-content:center;color:#333;background:#111;font-size:0.8rem;border:1px solid #222;">IMG</div>`;
                const isBm = userBookmarks.has(p.id);
                const bmClass = isBm ? 'active' : '';
                const bmBtn = `<button class="btn-bookmark ${bmClass}" onclick="event.stopPropagation(); toggleBookmark(${p.id})" style="position:absolute; top:10px; right:10px;">üîñ</button>`;

                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.style.position = 'relative';
                item.innerHTML = `
                    ${thumb}
                    <div class="timeline-info" style="padding-right:30px;">
                        <div style="display:flex; justify-content:space-between;">
                            ${renderTag(p.priority)}
                            <span style="font-size:0.7rem; color:#666;">${new Date(p.created_at).toLocaleDateString('de-DE')}</span>
                        </div>
                        <div class="timeline-title">${p.title}</div>
                        <div style="font-size:0.8rem; color:#888;">${p.subtitle || ''}</div>
                    </div>
                    ${bmBtn}
                `;
                item.onclick = () => openPost(p.id);
                timelineContainer.appendChild(item);
            };

            // If we are in 'bookmarks' or 'all' but searching (filter), we might want list only.
            // Current Logic: If 'bookmarks', Render ALL as list.

            let listPosts = allPosts;

            if (currentSection === 'all') {
                // Extract Featured
                const featured = allPosts[0];
                listPosts = allPosts.slice(1);

                const isBm = userBookmarks.has(featured.id);
                const bmClass = isBm ? 'active' : '';

                const featHtml = `
                    <div class="featured-card" onclick="openPost(${featured.id})">
                        ${featured.image_url ? `<img src="${featured.image_url}" class="featured-image">` : ''}
                        <div class="featured-content">
                            <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                                ${renderTag(featured.priority)}
                                <button class="btn-bookmark ${bmClass}" onclick="event.stopPropagation(); toggleBookmark(${featured.id})">üîñ</button>
                            </div>
                            <div class="post-title">${featured.title}</div>
                            <div class="post-subtitle">${featured.subtitle || ''}</div>
                            <div class="post-meta">
                                <span>üìÖ ${new Date(featured.created_at).toLocaleDateString('de-DE')}</span>
                                <span>üó®Ô∏è ${featured.comments_count || 0} Kommentare</span>
                                <span>üëç ${featured.likes || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
                featuredContainer.innerHTML = featHtml;
            }

            // Render List
            listPosts.forEach(p => renderListItem(p));
        }

        function filterPosts(term) {
            const t = term.toLowerCase();
            const filtered = allPosts.filter(p => p.title.toLowerCase().includes(t) || (p.subtitle && p.subtitle.toLowerCase().includes(t)));

            if(!t) {
                renderHub();
                return;
            }

            const featuredContainer = document.getElementById('featuredContainer');
            const timelineContainer = document.getElementById('timelineContainer');
            featuredContainer.innerHTML = '';
            timelineContainer.innerHTML = '';

            filtered.forEach(p => {
                const renderTag = (p) => {
                    let cls = 'tag-info';
                    if(p === 'Wichtig') cls = 'tag-wichtig';
                    if(p === 'Kritisch') cls = 'tag-kritisch';
                    return `<span class="post-tag ${cls}">${p}</span>`;
                };
                const thumb = p.image_url ? `<img src="${p.image_url}" class="timeline-thumb">` : `<div class="timeline-thumb" style="background:#111;"></div>`;
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    ${thumb}
                    <div class="timeline-info">
                        <div style="display:flex; justify-content:space-between;">
                            ${renderTag(p.priority)}
                            <span style="font-size:0.7rem; color:#666;">${new Date(p.created_at).toLocaleDateString('de-DE')}</span>
                        </div>
                        <div class="timeline-title">${p.title}</div>
                        <div style="font-size:0.8rem; color:#888;">${p.subtitle || ''}</div>
                    </div>
                `;
                item.onclick = () => openPost(p.id);
                timelineContainer.appendChild(item);
            });
        }

        async function openPost(id) {
            currentPostId = id;

            const url = new URL(window.location);
            url.searchParams.set('post', id);
            window.history.pushState({}, '', url);

            document.getElementById('hubView').style.display = 'none';
            document.getElementById('detailView').style.display = 'block';
            window.scrollTo(0,0);

            const container = document.getElementById('postDetailContent');
            container.innerHTML = '<div style="text-align:center; padding:50px;">Lade...</div>';

            try {
                const res = await fetch(`${API_BASE}/posts/${id}`);
                if(!res.ok) throw new Error(`Fetch Error: ${res.status} ${res.statusText}`);
                const post = await res.json();

                const renderTag = (p) => {
                    let cls = 'tag-info';
                    if(p === 'Wichtig') cls = 'tag-wichtig';
                    if(p === 'Kritisch') cls = 'tag-kritisch';
                    return `<span class="post-tag ${cls}">${p}</span>`;
                };

                const isBm = userBookmarks.has(post.id);
                const bmText = isBm ? 'Gespeichert' : 'Beitrag speichern';
                const bmClass = isBm ? 'active' : '';

                container.innerHTML = `
                    ${post.image_url ? `<img src="${post.image_url}" class="detail-header-img">` : ''}
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        ${renderTag(post.priority)}
                        <button class="btn-bookmark ${bmClass}" onclick="toggleBookmark(${post.id})" style="font-size:1rem; display:flex; align-items:center; gap:5px;">
                            <span>üîñ</span> <span id="bmText-${post.id}">${bmText}</span>
                        </button>
                    </div>
                    <h1 class="post-title">${post.title}</h1>
                    <div class="post-subtitle">${post.subtitle || ''}</div>
                    <div class="post-meta" style="margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #333;">
                        <span>üìÖ ${new Date(post.created_at).toLocaleString('de-DE')}</span>
                    </div>
                    <div class="detail-content">
                        ${marked.parse(post.content)}
                    </div>
                `;

                document.getElementById('countLike').textContent = post.likes || 0;
                document.getElementById('countDislike').textContent = post.dislikes || 0;
                document.getElementById('countQuestion').textContent = post.questions || 0;

                document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('active'));

                loadComments(id);
                setupCommentForm();

            } catch(e) {
                console.error("OpenPost Error:", e);
                container.innerHTML = `<div style="color:var(--error-red); text-align:center; padding:20px; border:1px solid var(--error-red); border-radius:8px;">
                    <strong>Fehler beim Laden</strong><br>
                    ${e.message}
                </div>`;
            }
        }

        function showHub() {
            document.getElementById('detailView').style.display = 'none';
            document.getElementById('hubView').style.display = 'block';
            currentPostId = null;

            const url = new URL(window.location);
            url.searchParams.delete('post');
            window.history.pushState({}, '', url);
            window.scrollTo(0,0);
        }

        // AUTH MODAL LOGIC
        function showLoginModal() {
            document.getElementById('authModal').style.display = 'flex';
        }
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        async function toggleBookmark(id) {
            if(!authToken) return showLoginModal();
            const isBm = userBookmarks.has(id);
            const method = isBm ? 'DELETE' : 'POST';

            try {
                const res = await fetch(`${API_BASE}/posts/${id}/bookmark`, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if(res.ok) {
                    if(isBm) userBookmarks.delete(id);
                    else userBookmarks.add(id);

                    window.showToast(isBm ? "Entfernt" : "Gespeichert", "success");

                    // Update UI if detail view
                    if(currentPostId == id) {
                        const txtEl = document.getElementById(`bmText-${id}`);
                        if(txtEl) txtEl.textContent = !isBm ? 'Gespeichert' : 'Beitrag speichern';
                        const btn = document.querySelector('.btn-bookmark');
                        if(btn) {
                            if(!isBm) btn.classList.add('active');
                            else btn.classList.remove('active');
                        }
                    } else {
                        // Refresh list to update icons
                        renderHub();
                    }
                }
            } catch(e) { window.showToast("Fehler", "error"); }
        }

        async function vote(type) {
            if(!authToken) { showLoginModal(); return; }
            if(!currentPostId) return;

            const btn = document.querySelector(`.vote-btn[onclick="vote('${type}')"]`);
            const allBtns = document.querySelectorAll('.vote-btn');
            allBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            try {
                await fetch(`${API_BASE}/posts/${currentPostId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ type })
                });
                const res = await fetch(`${API_BASE}/posts/${currentPostId}`);
                const post = await res.json();
                document.getElementById('countLike').textContent = post.likes;
                document.getElementById('countDislike').textContent = post.dislikes;
                document.getElementById('countQuestion').textContent = post.questions;
            } catch(e) { window.showToast("Fehler beim Bewerten", "error"); }
        }

        async function loadComments(id) {
            const list = document.getElementById('commentsList');
            list.innerHTML = 'Lade Kommentare...';
            try {
                const res = await fetch(`${API_BASE}/posts/${id}/comments`);
                const comments = await res.json();

                if(comments.length === 0) {
                    list.innerHTML = '<div style="color:#666; font-style:italic; margin-top:20px;">Keine Kommentare. Sei der Erste!</div>';
                    return;
                }

                list.innerHTML = '';

                // Tree building logic
                // Map comments by ID
                const commentMap = {};
                comments.forEach(c => {
                    c.children = [];
                    commentMap[c.id] = c;
                });

                const rootComments = [];
                comments.forEach(c => {
                    if(c.parent_id && commentMap[c.parent_id]) {
                        commentMap[c.parent_id].children.push(c);
                    } else {
                        rootComments.push(c);
                    }
                });

                // Helper to render tree
                const renderTree = (nodes, container, depth = 0) => {
                    nodes.forEach(c => {
                        const el = document.createElement('div');

                        // Badge Logic (Matched to Sidebar)
                        let badgeHtml = '';
                        let borderClass = '';

                        if (c.badge) {
                            const badgeName = c.badge.split(' ')[0].toLowerCase(); // e.g. "Dev üëæ" -> "dev"
                            const badgeCssClass = `user-badge badge-${badgeName}`;
                            badgeHtml = `<span class="${badgeCssClass}">${c.badge}</span>`;

                            // Map badge to border styling (Role)
                            if (['founder', 'admin', 'dev'].includes(badgeName)) borderClass = 'role-founder';
                            else if (badgeName === 'partner') borderClass = 'role-partner';
                            else if (badgeName === 'pro') borderClass = 'role-pro';
                            else if (badgeName === 'vip') borderClass = 'role-vip';
                        }

                        // Pinned Logic
                        const pinnedClass = c.is_pinned ? 'pinned' : '';
                        const pinnedHtml = c.is_pinned ? '<div class="pinned-badge">üìå PINNED</div>' : '';

                        el.className = `comment-item ${borderClass} ${pinnedClass}`;
                        el.innerHTML = `
                            ${pinnedHtml}
                            <div class="comment-header">
                                <div class="comment-user-area">
                                    <span class="comment-user">${c.username || 'User'}</span>
                                    ${badgeHtml}
                                </div>
                                <span class="comment-date">${new Date(c.created_at).toLocaleString('de-DE')}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(c.comment)}</div>
                            <div class="comment-actions">
                                <button class="action-btn" onclick="toggleReplyForm(${c.id})">‚Ü© Antworten</button>
                                <button class="action-btn" onclick="voteComment(${c.id}, 'like')">üëç ${c.likes || 0}</button>
                                <button class="action-btn" onclick="voteComment(${c.id}, 'dislike')">üëé ${c.dislikes || 0}</button>
                                ${isAdmin ? `<button class="action-btn mod-btn" onclick="deleteComment(${c.id})">üóëÔ∏è</button>` : ''}
                                ${isAdmin ? `<button class="action-btn mod-btn" onclick="pinComment(${c.id}, ${!c.is_pinned})">${c.is_pinned ? 'Unpin' : 'üìå'}</button>` : ''}
                            </div>
                            <div id="reply-form-${c.id}" style="display:none; margin-top:10px;"></div>
                            <div class="replies-container" id="replies-${c.id}"></div>
                        `;
                        container.appendChild(el);

                        if(c.children.length > 0) {
                            renderTree(c.children, el.querySelector(`#replies-${c.id}`), depth + 1);
                        }
                    });
                };

                renderTree(rootComments, list);

            } catch(e) { console.error(e); list.innerHTML = 'Fehler.'; }
        }

        function setupCommentForm() {
            const container = document.getElementById('commentFormRoot');
            if(authToken && currentUser) {
                container.innerHTML = `
                    <div class="comment-form">
                        <h4 style="color:#fff; margin-bottom:10px;">Kommentar schreiben als <span style="color:var(--accent-blue);">${currentUser.name || currentUser.username}</span></h4>
                        <textarea id="commentInput" class="comment-input" rows="3" placeholder="Deine Meinung..."></textarea>
                        <button onclick="postComment()" class="btn-comment">Senden</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="auth-overlay" onclick="showLoginModal()">
                        Um zu kommentieren oder abzustimmen, musst du eingeloggt sein.<br>
                        <span style="color:var(--accent-blue); font-weight:bold; text-decoration:underline;">Hier klicken zum Login</span>
                    </div>
                `;
            }
        }

        function toggleReplyForm(commentId) {
            if(!authToken) { showLoginModal(); return; }
            const container = document.getElementById(`reply-form-${commentId}`);
            if(container.style.display === 'block') {
                container.style.display = 'none';
                return;
            }
            // Clear others? Maybe not.
            container.innerHTML = `
                <div class="comment-form" style="background:#111; border-color:#444;">
                    <textarea id="replyInput-${commentId}" class="comment-input" rows="2" placeholder="Antwort..."></textarea>
                    <div style="text-align:right;">
                        <button onclick="toggleReplyForm(${commentId})" class="btn-cancel">Abbrechen</button>
                        <button onclick="postComment(${commentId})" class="btn-comment">Antworten</button>
                    </div>
                </div>
            `;
            container.style.display = 'block';
        }

        async function postComment(parentId = null) {
            let txt;
            if(parentId) {
                txt = document.getElementById(`replyInput-${parentId}`).value.trim();
            } else {
                txt = document.getElementById('commentInput').value.trim();
            }
            if(!txt) return;

            try {
                const payload = { comment: txt, parent_id: parentId };
                const res = await fetch(`${API_BASE}/posts/${currentPostId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.success) {
                    if(parentId) toggleReplyForm(parentId); // Close reply form
                    else document.getElementById('commentInput').value = ''; // Clear main form

                    loadComments(currentPostId);
                    window.showToast("Kommentar gesendet.", "success");
                } else {
                    window.showToast(data.error || "Fehler", "error");
                }
            } catch(e) { window.showToast("Fehler", "error"); }
        }

        async function voteComment(commentId, type) {
            if(!authToken) { showLoginModal(); return; }
            try {
                await fetch(`${API_BASE}/comments/${commentId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ type })
                });
                // Reload comments to update counts (simple but functional)
                loadComments(currentPostId);
            } catch(e) { window.showToast("Fehler", "error"); }
        }

        async function deleteComment(id) {
            if(!confirm("Kommentar wirklich l√∂schen?")) return;
            // Need Admin Token. The authToken in localStorage IS the user token.
            // If user is Admin, this token should work if backend validates role.
            // But wait, server.js uses 'requireAdmin' middleware which checks if token has 'role: admin'.
            // Standard login does NOT issue tokens with 'role: admin' unless /api/admin/auth was used.
            // If the user logged in via /api/admin/auth, they have a separate token.
            // This architecture splits User vs Admin completely.
            // IF I am "Admin" in this view, I probably need to use the admin token if I have one.
            // But this page is the PUBLIC forum. Admins view it as users usually.
            // If I want to moderate, I need to be logged in as Admin.
            // Since this is the public app, I only have `sm_token` (User Token).
            // Request said "User with role admin or dev". In `users` table, there is no role column, only `badge` or separate admin auth.
            // However, `server.js` `requireAdmin` checks for header `x-admin-password` OR a specific JWT format.
            // Standard users don't have this.
            // Solution: We'll assume for this task that "Moderation" is done by hitting endpoints that might check `users.badge` or `users.is_admin` (if it existed).
            // BUT: `server.js` has `requireAdmin` which is strict.
            // I will use `sm_admin_token` from sessionStorage (if available from Admin Panel login) as fallback auth header.

            let adminHeader = {};
            const adminToken = sessionStorage.getItem('sm_admin_token');
            if(adminToken) {
                adminHeader['Authorization'] = `Bearer ${adminToken}`;
            } else {
                // Try normal token? unlikely to work with requireAdmin middleware as is.
                // We'll try.
                adminHeader['Authorization'] = `Bearer ${authToken}`;
            }

            try {
                const res = await fetch(`${API_BASE}/comments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...adminHeader }
                });
                if(res.ok) {
                    window.showToast("Gel√∂scht.", "success");
                    loadComments(currentPostId);
                } else {
                    if(res.status === 403) {
                         window.showToast("Berechtigung fehlt. Bitte neu einloggen.", "error");
                    } else {
                         window.showToast("Fehler beim L√∂schen.", "error");
                    }
                }
            } catch(e) { window.showToast("Netzwerkfehler", "error"); }
        }

        async function pinComment(id, state) {
            let adminHeader = {};
            const adminToken = sessionStorage.getItem('sm_admin_token');
            if(adminToken) adminHeader['Authorization'] = `Bearer ${adminToken}`;
            else adminHeader['Authorization'] = `Bearer ${authToken}`;

            try {
                const res = await fetch(`${API_BASE}/comments/${id}/pin`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', ...adminHeader },
                    body: JSON.stringify({ pinned: state })
                });
                if(res.ok) {
                    window.showToast(state ? "Gepinnt" : "Gel√∂st", "success");
                    loadComments(currentPostId);
                } else {
                    const err = await res.json();
                    if(res.status === 403) {
                         window.showToast("Berechtigung fehlt. Bitte neu einloggen.", "error");
                    } else {
                         window.showToast("Fehler: " + (err.error || "Unbekannt"), "error");
                    }
                }
            } catch(e) { window.showToast("Netzwerkfehler", "error"); }
        }

        function escapeHtml(text) { if(!text) return ''; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    </script>
</body>
</html>
